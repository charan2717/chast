<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FABB — Chat</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; display:flex; flex-direction:column; height:100vh; background:#f4f6f8; }
  header { background:#2b6cb0; color:white; padding:10px 20px; font-size:20px; text-align:center; }

  /* Main container */
  #main { flex:1; display:flex; overflow:hidden; }

  /* Sidebar (desktop) */
  #sidebar { width:280px; background:#edf2f7; border-right:1px solid #cbd5e0; padding:12px; box-sizing:border-box; display:flex; flex-direction:column; }
  #sidebar h3 { margin-top:0; }
  #online-users { font-size:14px; color:#2d3748; margin-bottom:10px; }
  .panel { background:#fff; padding:10px; border-radius:8px; margin-bottom:12px; border:1px solid #e2e8f0; }
  .panel input { width:100%; box-sizing:border-box; margin:6px 0; padding:8px; border-radius:6px; border:1px solid #cbd5e0; }
  .panel button { width:100%; padding:8px; border:none; border-radius:6px; background:#2b6cb0; color:white; cursor:pointer; }

  /* Chat area */
  #chat-container { flex:1; display:flex; flex-direction:column; }
  #room-header { font-weight:bold; font-size:18px; padding:10px; text-align:center; color:#2b6cb0; display:none; }
  #chat-box { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; }
  .message { max-width:70%; padding:8px 12px; margin:5px 0; border-radius:15px; position:relative; word-wrap:break-word; }
  .sender { background:#2b6cb0; color:white; align-self:flex-end; }
  .receiver { background:#e2e8f0; color:#2d3748; align-self:flex-start; }
  .timestamp { font-size:10px; color:#718096; position:absolute; bottom:-12px; right:10px; }
  #typing { font-size:12px; color:#4a5568; margin:5px 10px; height:16px; }

  /* Input area */
  #input-area { display:flex; padding:10px; border-top:1px solid #cbd5e0; background:#fff; }
  #message { flex:1; padding:8px; border-radius:8px; border:1px solid #cbd5e0; }
  #send-btn, #file-btn { margin-left:5px; padding:8px 12px; border:none; border-radius:8px; cursor:pointer; }
  #send-btn { background:#2b6cb0; color:white; }
  #file-btn { background:#38a169; color:white; }

  /* Auth overlay */
  #auth { display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; }
  #auth input { margin:5px 0; padding:8px; border-radius:5px; border:1px solid #cbd5e0; width:200px; }
  #auth button { margin:5px; padding:8px 12px; border:none; border-radius:5px; background:#2b6cb0; color:white; cursor:pointer; }
  .muted { color:#718096; font-size:13px; }

  /* Mobile forms above chat */
  #mobile-room-ui { display:none; padding:10px; background:#edf2f7; }
  #mobile-room-ui .panel { margin-bottom:8px; }
  #rooms-toggle { display:none; margin:6px; padding:6px 10px; border:none; border-radius:6px; background:#2b6cb0; color:white; cursor:pointer; }

  /* Responsive */
  @media(max-width:768px){
    #main { flex-direction:column; }
    #sidebar { display:none; }
    #mobile-room-ui { display:none; } /* Hidden initially, shown after login */
  }
</style>
</head>
<body>
<header>FABB</header>

<!-- Auth -->
<div id="auth">
  <input id="username" placeholder="Username" autocomplete="off">
  <input id="password" placeholder="Password" type="password" autocomplete="off">
  <div>
    <button onclick="register()">Register</button>
    <button onclick="login()">Login</button>
  </div>
  <div style="margin-top:10px;" class="muted">Login to create/join rooms</div>
</div>

<!-- Mobile Room UI -->
<div id="mobile-room-ui">
  <button id="rooms-toggle" onclick="toggleRooms()">Rooms</button>
  <div id="mobile-rooms-panel" style="display:none">
    <div class="panel">
      <strong>Create Room</strong>
      <input id="create-room-id" placeholder="Room ID">
      <input id="create-room-password" placeholder="Password" type="password">
      <input id="create-room-name" placeholder="Room Name (optional)">
      <button onclick="createRoom()">Create & Join</button>
      <div id="create-room-status" class="muted"></div>
    </div>
    <div class="panel">
      <strong>Join Room</strong>
      <input id="join-room-id" placeholder="Room ID">
      <input id="join-room-password" placeholder="Password" type="password">
      <button onclick="joinRoom()">Join Room</button>
      <div id="join-room-status" class="muted"></div>
    </div>
  </div>
</div>

<!-- Main Chat Section -->
<div id="main" style="display:none;">
  <!-- Sidebar (desktop) -->
  <div id="sidebar">
    <h3>Online Users</h3>
    <div id="online-users" class="muted">—</div>
    <div class="panel">
      <strong>Create Room</strong>
      <input id="create-room-id-d" placeholder="Room ID">
      <input id="create-room-password-d" placeholder="Password" type="password">
      <input id="create-room-name-d" placeholder="Room Name (optional)">
      <button onclick="createRoom(true)">Create & Join</button>
      <div id="create-room-status-d" class="muted"></div>
    </div>
    <div class="panel">
      <strong>Join Room</strong>
      <input id="join-room-id-d" placeholder="Room ID">
      <input id="join-room-password-d" placeholder="Password" type="password">
      <button onclick="joinRoom(true)">Join Room</button>
      <div id="join-room-status-d" class="muted"></div>
    </div>
    <div class="panel">
      <strong>Current</strong>
      <div class="muted">User: <span id="me">—</span></div>
      <div class="muted">Room: <span id="current-room">—</span></div>
      <button onclick="leaveRoom()" style="margin-top:6px;background:#e53e3e;">Leave Room</button>
    </div>
  </div>

  <!-- Chat Container -->
  <div id="chat-container">
    <div id="room-header"></div>
    <div id="chat-box"></div>
    <div id="typing"></div>
    <div id="input-area">
      <input id="message" placeholder="Type message..." disabled>
      <button id="send-btn" onclick="sendMessage()" disabled>Send</button>
      <input type="file" id="fileInput" style="display:none;">
      <button id="file-btn" onclick="document.getElementById('fileInput').click()" disabled>File</button>
    </div>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const SERVER = "https://chast.onrender.com";
const socket = io(SERVER,{transports:["websocket","polling"]});
let currentUsername = "", currentRoom = "", currentRoomPassword = "", loggedIn=false;

function escapeHtml(s){if(!s && s!==0) return"";return String(s).replace(/[&<>"'`=\/]/g, ch=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"}[ch]));}
function appendMessage(sender,text,ts="",type="text"){const box=document.getElementById("chat-box");const div=document.createElement("div");div.className=sender===currentUsername?"message sender":"message receiver";if(type==="text")div.innerHTML=`<b>${escapeHtml(sender)}:</b> ${escapeHtml(text)}<span class="timestamp">${ts}</span>`;else div.innerHTML=`<b>${escapeHtml(sender)} sent file:</b> <a href="${SERVER}/uploads/${encodeURIComponent(text)}" target="_blank">${escapeHtml(text)}</a><span class="timestamp">${ts}</span>`;box.appendChild(div);box.scrollTop=box.scrollHeight;}
function setLoggedInUI(){document.getElementById("auth").style.display="none";document.getElementById("main").style.display="flex";document.getElementById("me").innerText=currentUsername;if(window.innerWidth<=768) document.getElementById("mobile-room-ui").style.display="block";}
function toggleRooms(){const panel=document.getElementById("mobile-rooms-panel");panel.style.display=panel.style.display==="block"?"none":"block";}

// Auth
function register(){const u=document.getElementById("username").value.trim();const p=document.getElementById("password").value;if(!u||!p){alert("username and password required");return;}fetch(SERVER+"/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:p})}).then(r=>r.json()).then(d=>{d.success?alert("Registered! Now login."):alert("Error: "+(d.error||"unknown"))});}
function login(){const u=document.getElementById("username").value.trim();const p=document.getElementById("password").value;if(!u||!p){alert("username and password required");return;}fetch(SERVER+"/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,password:p})}).then(r=>r.json()).then(d=>{if(d.success){currentUsername=u;loggedIn=true;setLoggedInUI();}else alert("Error: "+(d.error||"invalid"));});}

// Enable chat after join
function enableChatUI(){document.getElementById("message").disabled=false;document.getElementById("send-btn").disabled=false;document.getElementById("file-btn").disabled=false;}

// Create / Join Room
function createRoom(desktop=false){
  const rid=document.getElementById(desktop?"create-room-id-d":"create-room-id").value.trim();
  const rpass=document.getElementById(desktop?"create-room-password-d":"create-room-password").value.trim();
  const rname=document.getElementById(desktop?"create-room-name-d":"create-room-name").value.trim();
  if(!rid||!rpass){alert("Room ID and password required");return;}
  fetch(SERVER+"/create_room",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_id:rid,password:rpass,name:rname})})
  .then(r=>r.json()).then(d=>{if(d.success){currentRoom=rid;currentRoomPassword=rpass;document.getElementById("room-header").innerText=rname?rname:"Room: "+rid;document.getElementById("current-room").innerText=rid;document.getElementById("mobile-rooms-panel").style.display="none";enableChatUI();socket.emit("join",{room:rid,username:currentUsername,password:rpass});}else alert(d.error||"Error creating room");});
}

function joinRoom(desktop=false){
  const rid=document.getElementById(desktop?"join-room-id-d":"join-room-id").value.trim();
  const rpass=document.getElementById(desktop?"join-room-password-d":"join-room-password").value.trim();
  if(!rid||!rpass){alert("Room ID and password required");return;}
  fetch(SERVER+"/join_room",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({room_id:rid,password:rpass})})
  .then(r=>r.json()).then(d=>{if(d.success){currentRoom=rid;currentRoomPassword=rpass;document.getElementById("room-header").innerText="Room: "+rid;document.getElementById("current-room").innerText=rid;document.getElementById("mobile-rooms-panel").style.display="none";enableChatUI();document.getElementById("chat-box").innerHTML="";socket.emit("join",{room:rid,username:currentUsername,password:rpass});}else alert(d.error||"Error joining room");});
}

// Leave Room
function leaveRoom(){socket.emit("disconnect_user",{username:currentUsername,room:currentRoom});currentRoom="";document.getElementById("room-header").style.display="none";document.getElementById("chat-box").innerHTML="";document.getElementById("message").disabled=true;document.getElementById("send-btn").disabled=true;document.getElementById("file-btn").disabled=true;}

// Send message
function sendMessage(){const text=document.getElementById("message").value;if(!text.trim()||!currentRoom) return;socket.emit("send_message",{room:currentRoom,sender:currentUsername,text});document.getElementById("message").value="";}

// File upload
document.getElementById("fileInput").addEventListener("change", ()=>{
  const file=document.getElementById("fileInput").files[0];if(!file||!currentRoom)return;
  const form=new FormData();form.append("file",file);form.append("room",currentRoom);form.append("sender",currentUsername);
  fetch(SERVER+"/upload",{method:"POST",body:form});
  document.getElementById("fileInput").value="";
});

// Typing
document.getElementById("message").addEventListener("input", ()=>{if(currentRoom)socket.emit("typing",{room:currentRoom,username:currentUsername});});

// Socket Events
socket.on("message", data=>{appendMessage(data.sender,data.text,data.timestamp,data.type);});
socket.on("chat_history", messages=>{document.getElementById("chat-box").innerHTML="";messages.forEach(m=>appendMessage(m.sender,m.text,m.timestamp,m.type));});
socket.on("user_status", data=>{document.getElementById("online-users").innerText=data.online_users.join(", ");});
socket.on("typing", data=>{const el=document.getElementById("typing");el.innerText=data.username+" is typing...";setTimeout(()=>{el.innerText="";},1000);});

// Auto disconnect
window.addEventListener("beforeunload", ()=>{if(currentRoom)socket.emit("disconnect_user",{username:currentUsername,room:currentRoom});});
</script>
</body>
</html>
